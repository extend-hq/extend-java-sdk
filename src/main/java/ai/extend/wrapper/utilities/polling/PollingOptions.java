/**
 * Custom wrapper code - not auto-generated by Fern.
 */
package ai.extend.wrapper.utilities.polling;

import ai.extend.core.RequestOptions;

/**
 * Configuration options for polling operations with hybrid polling strategy.
 *
 * <p>The default strategy polls at 1-second intervals for the first 30 seconds,
 * then gradually increases the interval using exponential backoff (1.15x multiplier)
 * up to a maximum of 30 seconds between polls.</p>
 *
 * <p>Use the builder pattern to create instances with custom values:</p>
 * <pre>{@code
 * // Polls indefinitely with default hybrid strategy
 * PollingOptions options = PollingOptions.builder().build();
 *
 * // With custom timeout
 * PollingOptions options = PollingOptions.builder()
 *     .maxWaitMs(300000)  // 5 minutes
 *     .build();
 *
 * // Custom fast polling phase
 * PollingOptions options = PollingOptions.builder()
 *     .fastPollDurationMs(60000)  // Fast poll for 60 seconds
 *     .fastPollIntervalMs(500)    // Poll every 500ms during fast phase
 *     .build();
 * }</pre>
 */
public class PollingOptions {

    /**
     * Default fast poll duration: 30 seconds (30,000 ms).
     */
    public static final int DEFAULT_FAST_POLL_DURATION_MS = 30_000;

    /**
     * Default fast poll interval: 1 second (1,000 ms).
     */
    public static final int DEFAULT_FAST_POLL_INTERVAL_MS = 1_000;

    /**
     * Default initial delay for backoff phase: 1 second (1,000 ms).
     */
    public static final int DEFAULT_INITIAL_DELAY_MS = 1_000;

    /**
     * Default maximum delay between polls: 30 seconds (30,000 ms).
     */
    public static final int DEFAULT_MAX_DELAY_MS = 30_000;

    /**
     * Default backoff multiplier: 1.15 (15% increase each attempt).
     */
    public static final double DEFAULT_BACKOFF_MULTIPLIER = 1.15;

    /**
     * Default jitter fraction: 0.25 (±25% randomization).
     */
    public static final double DEFAULT_JITTER_FRACTION = 0.25;

    private final Integer maxWaitMs; // null = poll indefinitely
    private final int fastPollDurationMs;
    private final int fastPollIntervalMs;
    private final int initialDelayMs;
    private final int maxDelayMs;
    private final double backoffMultiplier;
    private final double jitterFraction;
    private final RequestOptions requestOptions;

    private PollingOptions(Builder builder) {
        this.maxWaitMs = builder.maxWaitMs;
        this.fastPollDurationMs = builder.fastPollDurationMs;
        this.fastPollIntervalMs = builder.fastPollIntervalMs;
        this.initialDelayMs = builder.initialDelayMs;
        this.maxDelayMs = builder.maxDelayMs;
        this.backoffMultiplier = builder.backoffMultiplier;
        this.jitterFraction = builder.jitterFraction;
        this.requestOptions = builder.requestOptions;
    }

    /**
     * Returns the maximum total wait time in milliseconds, or null if polling indefinitely.
     */
    public Integer getMaxWaitMs() {
        return maxWaitMs;
    }

    /**
     * Returns whether a timeout is configured.
     */
    public boolean hasTimeout() {
        return maxWaitMs != null;
    }

    /**
     * Returns the duration of the fast polling phase in milliseconds.
     */
    public int getFastPollDurationMs() {
        return fastPollDurationMs;
    }

    /**
     * Returns the interval between polls during the fast polling phase in milliseconds.
     */
    public int getFastPollIntervalMs() {
        return fastPollIntervalMs;
    }

    /**
     * Returns the initial delay for the backoff phase in milliseconds.
     */
    public int getInitialDelayMs() {
        return initialDelayMs;
    }

    /**
     * Returns the maximum delay between polls in milliseconds.
     */
    public int getMaxDelayMs() {
        return maxDelayMs;
    }

    /**
     * Returns the multiplier for exponential backoff.
     */
    public double getBackoffMultiplier() {
        return backoffMultiplier;
    }

    /**
     * Returns the jitter fraction for delay randomization.
     */
    public double getJitterFraction() {
        return jitterFraction;
    }

    /**
     * Returns the request options to pass to API calls.
     */
    public RequestOptions getRequestOptions() {
        return requestOptions;
    }

    /**
     * Creates a new builder with default values.
     */
    public static Builder builder() {
        return new Builder();
    }

    /**
     * Creates default polling options (polls indefinitely).
     */
    public static PollingOptions defaults() {
        return new Builder().build();
    }

    /**
     * Builder for {@link PollingOptions}.
     */
    public static class Builder {
        private Integer maxWaitMs = null; // null = poll indefinitely
        private int fastPollDurationMs = DEFAULT_FAST_POLL_DURATION_MS;
        private int fastPollIntervalMs = DEFAULT_FAST_POLL_INTERVAL_MS;
        private int initialDelayMs = DEFAULT_INITIAL_DELAY_MS;
        private int maxDelayMs = DEFAULT_MAX_DELAY_MS;
        private double backoffMultiplier = DEFAULT_BACKOFF_MULTIPLIER;
        private double jitterFraction = DEFAULT_JITTER_FRACTION;
        private RequestOptions requestOptions;

        /**
         * Sets the maximum total wait time in milliseconds.
         * Default: null (polls indefinitely)
         */
        public Builder maxWaitMs(int maxWaitMs) {
            this.maxWaitMs = maxWaitMs;
            return this;
        }

        /**
         * Sets the duration of the fast polling phase in milliseconds.
         * During this phase, polls occur at a fixed interval (fastPollIntervalMs).
         * Default: 30000 (30 seconds)
         */
        public Builder fastPollDurationMs(int fastPollDurationMs) {
            this.fastPollDurationMs = fastPollDurationMs;
            return this;
        }

        /**
         * Sets the interval between polls during the fast polling phase in milliseconds.
         * Default: 1000 (1 second)
         */
        public Builder fastPollIntervalMs(int fastPollIntervalMs) {
            this.fastPollIntervalMs = fastPollIntervalMs;
            return this;
        }

        /**
         * Sets the initial delay for the backoff phase in milliseconds.
         * Default: 1000 (1 second)
         */
        public Builder initialDelayMs(int initialDelayMs) {
            this.initialDelayMs = initialDelayMs;
            return this;
        }

        /**
         * Sets the maximum delay between polls in milliseconds.
         * Default: 30000 (30 seconds)
         */
        public Builder maxDelayMs(int maxDelayMs) {
            this.maxDelayMs = maxDelayMs;
            return this;
        }

        /**
         * Sets the multiplier for exponential backoff during the backoff phase.
         * A value of 1.15 means each delay is 1.15x the previous delay.
         * Default: 1.15
         */
        public Builder backoffMultiplier(double backoffMultiplier) {
            this.backoffMultiplier = backoffMultiplier;
            return this;
        }

        /**
         * Sets the jitter fraction for delay randomization.
         * A value of 0.25 means delays will be randomized by ±25%.
         * Default: 0.25
         */
        public Builder jitterFraction(double jitterFraction) {
            this.jitterFraction = jitterFraction;
            return this;
        }

        /**
         * Sets the request options to pass to API calls.
         */
        public Builder requestOptions(RequestOptions requestOptions) {
            this.requestOptions = requestOptions;
            return this;
        }

        /**
         * Builds the {@link PollingOptions} instance.
         */
        public PollingOptions build() {
            return new PollingOptions(this);
        }
    }
}

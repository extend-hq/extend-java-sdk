/**
 * Custom wrapper code - not auto-generated by Fern.
 */
package ai.extend.wrapper;

import ai.extend.ExtendClient;
import ai.extend.ExtendClientBuilder;
import ai.extend.core.ClientOptions;
import ai.extend.core.Suppliers;
import ai.extend.wrapper.resources.ClassifyRunsWrapper;
import ai.extend.wrapper.resources.EditRunsWrapper;
import ai.extend.wrapper.resources.ExtractRunsWrapper;
import ai.extend.wrapper.resources.ParseRunsWrapper;
import ai.extend.wrapper.resources.SplitRunsWrapper;
import ai.extend.wrapper.resources.WorkflowRunsWrapper;
import ai.extend.wrapper.webhooks.Webhooks;
import java.util.function.Supplier;

/**
 * Wrapper for the Extend API client with additional polling and webhook utilities.
 *
 * <p>Extends the generated {@link ExtendClient}, so all generated methods (parse, edit,
 * extract, classify, split, files, extractors, classifiers, splitters, workflows,
 * evaluation sets, etc.) are available directly.</p>
 *
 * <p>Additionally provides:</p>
 * <ul>
 *   <li>{@code createAndPoll} on all run resources (extractRuns, classifyRuns, etc.)</li>
 *   <li>{@code webhooks()} for signature verification</li>
 * </ul>
 *
 * <h3>Basic Usage</h3>
 * <pre>{@code
 * ExtendClientWrapper client = ExtendClientWrapper.builder()
 *     .token("your-api-key")
 *     .build();
 *
 * // Synchronous convenience methods (inherited from ExtendClient)
 * ParseRun parseResult = client.parse(ParseRequest.builder().file(...).build());
 * ExtractRun extractResult = client.extract(ExtractRequest.builder().file(...).build());
 *
 * // Create and poll an extract run
 * ExtractRun response = client.extractRuns().createAndPoll(
 *     ExtractRunsCreateRequest.builder()
 *         .file(...)
 *         .extractor(...)
 *         .build()
 * );
 * }</pre>
 *
 * <h3>Webhook Verification</h3>
 * <pre>{@code
 * Map<String, Object> event = client.webhooks().verifyAndParse(
 *     requestBody,
 *     requestHeaders,
 *     signingSecret
 * );
 * }</pre>
 */
public class ExtendClientWrapper extends ExtendClient {

    private final Webhooks webhooks;

    // Lazy-initialized run wrappers that override the generated client accessors
    private final Supplier<ExtractRunsWrapper> extractRunsWrapper;
    private final Supplier<ClassifyRunsWrapper> classifyRunsWrapper;
    private final Supplier<SplitRunsWrapper> splitRunsWrapper;
    private final Supplier<ParseRunsWrapper> parseRunsWrapper;
    private final Supplier<EditRunsWrapper> editRunsWrapper;
    private final Supplier<WorkflowRunsWrapper> workflowRunsWrapper;

    public ExtendClientWrapper(ClientOptions clientOptions) {
        super(clientOptions);
        this.webhooks = new Webhooks();

        // Lazy initialization of wrappers
        this.extractRunsWrapper = Suppliers.memoize(() -> new ExtractRunsWrapper(clientOptions));
        this.classifyRunsWrapper = Suppliers.memoize(() -> new ClassifyRunsWrapper(clientOptions));
        this.splitRunsWrapper = Suppliers.memoize(() -> new SplitRunsWrapper(clientOptions));
        this.parseRunsWrapper = Suppliers.memoize(() -> new ParseRunsWrapper(clientOptions));
        this.editRunsWrapper = Suppliers.memoize(() -> new EditRunsWrapper(clientOptions));
        this.workflowRunsWrapper = Suppliers.memoize(() -> new WorkflowRunsWrapper(clientOptions));
    }

    /**
     * Returns the webhook utilities for signature verification.
     */
    public Webhooks webhooks() {
        return webhooks;
    }

    // ========== Override run accessors to return wrappers with createAndPoll ==========

    /**
     * Returns the extract runs wrapper with createAndPoll support.
     * All standard methods (create, list, retrieve, delete, cancel) are also available.
     */
    @Override
    public ExtractRunsWrapper extractRuns() {
        return extractRunsWrapper.get();
    }

    /**
     * Returns the classify runs wrapper with createAndPoll support.
     * All standard methods (create, list, retrieve, delete, cancel) are also available.
     */
    @Override
    public ClassifyRunsWrapper classifyRuns() {
        return classifyRunsWrapper.get();
    }

    /**
     * Returns the split runs wrapper with createAndPoll support.
     * All standard methods (create, list, retrieve, delete, cancel) are also available.
     */
    @Override
    public SplitRunsWrapper splitRuns() {
        return splitRunsWrapper.get();
    }

    /**
     * Returns the parse runs wrapper with createAndPoll support.
     * All standard methods (create, retrieve, delete) are also available.
     */
    @Override
    public ParseRunsWrapper parseRuns() {
        return parseRunsWrapper.get();
    }

    /**
     * Returns the edit runs wrapper with createAndPoll support.
     * All standard methods (create, retrieve, delete) are also available.
     */
    @Override
    public EditRunsWrapper editRuns() {
        return editRunsWrapper.get();
    }

    /**
     * Returns the workflow runs wrapper with createAndPoll support.
     * All standard methods (create, list, retrieve, update, delete, cancel, createBatch) are also available.
     */
    @Override
    public WorkflowRunsWrapper workflowRuns() {
        return workflowRunsWrapper.get();
    }

    /**
     * Creates a new builder for ExtendClientWrapper.
     */
    public static Builder builder() {
        return new Builder();
    }

    /**
     * Builder for {@link ExtendClientWrapper}.
     * Extends the generated {@link ExtendClientBuilder} so all standard options
     * (token, environment, url, timeout, maxRetries, etc.) are available.
     */
    public static class Builder extends ExtendClientBuilder {

        /**
         * Sets the API key (convenience alias for {@link #token(String)}).
         */
        public Builder apiKey(String apiKey) {
            super.token(apiKey);
            return this;
        }

        /**
         * Sets a custom base URL (convenience alias for {@link #url(String)}).
         */
        public Builder baseUrl(String baseUrl) {
            super.url(baseUrl);
            return this;
        }

        @Override
        public ExtendClientWrapper build() {
            return new ExtendClientWrapper(buildClientOptions());
        }
    }
}

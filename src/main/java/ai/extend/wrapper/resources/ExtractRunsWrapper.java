/**
 * Custom wrapper code - not auto-generated by Fern.
 */
package ai.extend.wrapper.resources;

import ai.extend.core.ClientOptions;
import ai.extend.core.RequestOptions;
import ai.extend.resources.extractruns.ExtractRunsClient;
import ai.extend.resources.extractruns.requests.ExtractRunsCreateRequest;
import ai.extend.types.ExtractRun;
import ai.extend.types.ProcessorRunStatus;
import ai.extend.wrapper.utilities.polling.Polling;
import ai.extend.wrapper.utilities.polling.PollingOptions;
import java.util.HashSet;
import java.util.Set;

/**
 * Wrapper for ExtractRunsClient that adds polling functionality.
 *
 * <p>Extends {@link ExtractRunsClient}, so all standard methods (list, create, retrieve,
 * delete, cancel) are inherited. Adds {@code createAndPoll} for convenience.</p>
 */
public class ExtractRunsWrapper extends ExtractRunsClient {

    private static final Set<ProcessorRunStatus> NON_TERMINAL_STATUSES;

    static {
        NON_TERMINAL_STATUSES = new HashSet<ProcessorRunStatus>();
        NON_TERMINAL_STATUSES.add(ProcessorRunStatus.PROCESSING);
    }

    public ExtractRunsWrapper(ClientOptions clientOptions) {
        super(clientOptions);
    }

    /**
     * Creates an extract run and polls until it reaches a terminal state.
     *
     * <p>Terminal states: PROCESSED, FAILED, CANCELLED</p>
     *
     * <p>Polls indefinitely until complete.</p>
     *
     * @param request The create request
     * @return The final response when a terminal state is reached
     */
    public ExtractRun createAndPoll(ExtractRunsCreateRequest request) {
        return createAndPoll(request, PollingOptions.defaults());
    }

    /**
     * Creates an extract run and polls until it reaches a terminal state.
     *
     * <p>Terminal states: PROCESSED, FAILED, CANCELLED</p>
     *
     * @param request The create request
     * @param options Polling options
     * @return The final response when a terminal state is reached
     */
    public ExtractRun createAndPoll(ExtractRunsCreateRequest request, PollingOptions options) {

        RequestOptions requestOptions = options.getRequestOptions();

        // Create the extract run
        ExtractRun createResponse = this.create(request, requestOptions);
        final String runId = createResponse.getId();

        // Poll until terminal state
        return Polling.pollUntilDone(
                () -> this.retrieve(runId, requestOptions),
                response -> isTerminalStatus(response.getStatus()),
                options);
    }

    private boolean isTerminalStatus(ProcessorRunStatus status) {
        return !NON_TERMINAL_STATUSES.contains(status);
    }
}
